{% extends "base.html" %}
{% load static %}

{% block title %}Регистрация - Бартер Онлайн{% endblock %}

{% block extra_head %}
<style>
    .signup-container {
        max-width: 550px;
        margin-top: 2rem;
        margin-bottom: 3rem;
        padding: 2rem;
        background-color: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    }
    .signup-container h2 {
        margin-bottom: 1.5rem;
        text-align: center;
        color: #343a40;
    }

    /* Стили для form-floating */
    .form-floating > .form-control,
    .form-floating > .form-select {
        height: calc(3.5rem + 2px);
        line-height: 1.25;
        padding-top: 1.625rem;
        padding-bottom: 0.625rem;
    }
    .form-floating > label {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        padding: 1rem 0.75rem;
        pointer-events: none;
        border: 1px solid transparent;
        transform-origin: 0 0;
        transition: opacity 0.1s ease-in-out, transform 0.1s ease-in-out;
        color: #6c757d;
    }
    .form-floating > .form-control:focus ~ label,
    .form-floating > .form-control:not(:placeholder-shown) ~ label,
    .form-floating > .form-select ~ label { /* Для select, если будете использовать */
        opacity: 0.65;
        transform: scale(0.85) translateY(-0.5rem) translateX(0.15rem);
    }
    .form-control:focus {
        border-color: #86b7fe; /* Bootstrap focus color */
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
     /* Стили для Bootstrap is-valid / is-invalid */
    .form-control.is-valid, .was-validated .form-control:valid {
        border-color: #198754; /* success */
        padding-right: calc(1.5em + .75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4M3.7 6.73L1.3 4.53c-.4-1.04.46-1.4M7.4 1.23L4.1 5.83c-.4 1.04.46 1.4'%3e%3c/path%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(.375em + .1875rem) center;
        background-size: calc(.75em + .375rem) calc(.75em + .375rem);
    }
    .form-control.is-valid:focus {
        border-color: #198754;
        box-shadow: 0 0 0 .25rem rgba(25, 135, 84, .25);
    }
    .form-control.is-invalid, .was-validated .form-control:invalid {
        border-color: #dc3545; /* danger */
        padding-right: calc(1.5em + .75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(.375em + .1875rem) center;
        background-size: calc(.75em + .375rem) calc(.75em + .375rem);
    }
    .form-control.is-invalid:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 .25rem rgba(220, 53, 69, .25);
    }


    /* Стили для динамических подсказок валидации */
    .field-validation-feedback,
    .password-requirements {
        font-size: 0.875em;
        padding-left: 0.5rem;
        margin-top: 0.25rem; /* Уменьшил отступ, чтобы было ближе к полю */
        margin-bottom: 1rem;
        opacity: 0;
        max-height: 0;
        overflow: hidden;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out, visibility 0s linear 0.3s;
    }

    .field-validation-feedback.visible,
    .password-requirements.visible {
        opacity: 1;
        max-height: 200px; /* Достаточно для большинства списков правил */
        visibility: visible;
        transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out, visibility 0s linear 0s;
    }

    .field-validation-feedback ul,
    .password-requirements ul { list-style: none; padding: 0; margin: 0; }

    .field-validation-feedback li,
    .password-requirements li {
        margin-bottom: 0.3rem;
        color: #6c757d; /* Изначальный цвет */
        position: relative;
        padding-left: 1.3em; /* Место для иконки */
        line-height: 1.4;
    }
    .field-validation-feedback li::before,
    .password-requirements li::before {
        font-family: 'bootstrap-icons', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; /* Используем шрифт Bootstrap Icons или системный */
        position: absolute;
        left: 0;
        font-weight: bold;
    }
    .field-validation-feedback li.valid,
    .password-requirements li.valid {
        color: #198754; /* Bootstrap success */
    }
    .field-validation-feedback li.valid::before,
    .password-requirements li.valid::before {
        content: "\F26E"; /* Bootstrap Icons check-lg */
        color: #198754;
    }
    .field-validation-feedback li.invalid,
    .password-requirements li.invalid {
        color: #dc3545; /* Bootstrap danger */
    }
    .field-validation-feedback li.invalid::before,
    .password-requirements li.invalid::before {
        content: "\F622"; /* Bootstrap Icons x-lg */
        color: #dc3545;
    }
    /* Скрываем стандартный Bootstrap invalid-feedback, если используем свой (если не нужен вообще) */
    .form-floating > .invalid-feedback.server-error:not(:empty) { display: block !important; } /* Показываем только серверные ошибки, если они есть */
    .form-floating > .invalid-feedback:not(.server-error) { display: none !important; }
</style>
{% endblock %}

{% block content %}
<div class="container signup-container">
    <h2>Регистрация нового пользователя</h2>

    {% if form.non_field_errors %}
        <div class="alert alert-danger mt-3" role="alert">
            {% for error in form.non_field_errors %}
                <p class="mb-0">{{ error }}</p>
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" class="mt-3" novalidate>
        {% csrf_token %}

        {% for field in form %}
            <div class="form-floating mb-2">
                {{ field }} {# Рендерит <input>, <select> и т.д. #}
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                
                {# Серверные ошибки Django (если JS валидация их не обработала или их нет в JS) #}
                {% if field.errors %}
                    <div class="invalid-feedback d-block server-error">
                        {% for error in field.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            {# Динамический блок для валидации username #}
            {% if field.name == 'username' %}
            <div id="username-feedback" class="field-validation-feedback mb-3">
                <p class="mb-1 small text-muted">Имя пользователя должно:</p>
                <ul>
                    <li id="un-length">Быть от 3 до 150 символов.</li>
                    <li id="un-chars">Содержать только буквы, цифры и @/./+/-/_.</li>
                </ul>
            </div>
            {% endif %}

            {# Динамический блок для валидации email #}
            {% if field.name == 'email' %}
            <div id="email-feedback" class="field-validation-feedback mb-3">
                <p class="mb-1 small text-muted">Email должен:</p>
                <ul>
                    <li id="em-format">Иметь корректный формат (например, user@example.com).</li>
                </ul>
            </div>
            {% endif %}

            {# Динамический блок для требований к паролю #}
            {% if field.name == 'password' %}
            <div id="password-rules-container" class="password-requirements mb-3">
                <p class="mb-1 small text-muted">Пароль должен:</p>
                <ul>
                    <li id="pr-length">Содержать не менее 8 символов.</li>
                    <li id="pr-letter">Содержать хотя бы одну букву.</li>
                    <li id="pr-number">Содержать хотя бы одну цифру.</li>
                </ul>
            </div>
            {% endif %}

            {# Динамический блок для проверки совпадения паролей #}
             {% if field.name == 'password2' %}
            <div id="password2-feedback" class="field-validation-feedback mb-3">
                <ul>
                    <li id="p2-match">Пароли должны совпадать.</li>
                </ul>
            </div>
            {% endif %}

        {% endfor %}
        
        <div class="d-grid mt-4">
            <button type="submit" class="btn btn-primary btn-lg">Зарегистрироваться</button>
        </div>
    </form>

    <div class="mt-4 text-center">
        <p>Уже есть аккаунт? <a href="{% url 'login' %}">Войти</a></p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Добавление классов form-control/form-select и placeholder
    const formElements = document.querySelectorAll('.signup-container form .form-floating > input, .signup-container form .form-floating > select, .signup-container form .form-floating > textarea');
    formElements.forEach(function(el) {
        if (!el.classList.contains('form-control') && el.tagName.toLowerCase() !== 'select') {
            el.classList.add('form-control');
        }
        if (el.tagName.toLowerCase() === 'select' && !el.classList.contains('form-select')) {
            el.classList.add('form-select');
        }
        if (!el.hasAttribute('placeholder') && (el.type === 'text' || el.type === 'email' || el.type === 'password' || el.tagName.toLowerCase() === 'textarea')) {
            el.setAttribute('placeholder', ' ');
        }
        
        // Показываем is-invalid для серверных ошибок, если JS блок их не перекроет
        const serverErrorDiv = el.closest('.form-floating').querySelector('.server-error.d-block');
        if (serverErrorDiv) {
            el.classList.add('is-invalid');
        }
    });

    function updateValidationRuleUI(ruleElement, isValid, fieldElement, markInvalidIfNotEmpty = true) {
        if (isValid) {
            ruleElement.classList.add('valid');
            ruleElement.classList.remove('invalid');
        } else {
            ruleElement.classList.remove('valid');
            if (markInvalidIfNotEmpty && fieldElement.value.length > 0) {
                ruleElement.classList.add('invalid');
            } else {
                ruleElement.classList.remove('invalid'); // Сбрасываем, если поле пустое
            }
        }
    }
    
    function areAllRulesValid(feedbackDiv) {
        if (!feedbackDiv) return false;
        const rules = feedbackDiv.querySelectorAll('ul li');
        for (let rule of rules) {
            if (rule.style.display !== 'none' && !rule.classList.contains('valid')) {
                return false;
            }
        }
        return true;
    }

    function setupFieldValidation(fieldId, feedbackDivId, rulesToQuery, validationFunction, options = {}) {
        const fieldElement = document.getElementById(fieldId);
        const feedbackDiv = document.getElementById(feedbackDivId);

        if (!fieldElement || !feedbackDiv) {
            // console.warn(`Element not found for fieldId: ${fieldId} or feedbackDivId: ${feedbackDivId}`);
            return;
        }

        const rules = {};
        if (rulesToQuery) {
            for (const ruleKey in rulesToQuery) {
                rules[ruleKey] = feedbackDiv.querySelector(rulesToQuery[ruleKey]);
                // if (!rules[ruleKey]) console.warn(`Rule element not found for selector: ${rulesToQuery[ruleKey]} in ${feedbackDivId}`);
            }
        }

        const handleFocus = () => {
            feedbackDiv.classList.add('visible');
            if (validationFunction) validationFunction(fieldElement, feedbackDiv, rules);
        };

        const handleInput = () => {
            if (validationFunction) validationFunction(fieldElement, feedbackDiv, rules);
        };

        const handleBlur = () => {
            if (fieldElement.value.length === 0) {
                feedbackDiv.classList.remove('visible');
                fieldElement.classList.remove('is-valid', 'is-invalid');
                if (rules) {
                    Object.values(rules).forEach(ruleEl => {
                        if (ruleEl) ruleEl.classList.remove('valid', 'invalid');
                    });
                }
            } else if (options.hideOnValidBlur && areAllRulesValid(feedbackDiv)) {
                feedbackDiv.classList.remove('visible');
            }
        };

        fieldElement.addEventListener('focus', handleFocus);
        if (validationFunction) {
            fieldElement.addEventListener('input', handleInput);
        }
        fieldElement.addEventListener('blur', handleBlur);
    }

    // --- Применение общей функции к полям ---
    setupFieldValidation(
        '{{ form.username.id_for_label }}', 
        'username-feedback', 
        { length: '#un-length', chars: '#un-chars' }, 
        function validateUsername(field, feedbackDiv, rules) {
            const value = field.value;
            let isFieldValidOverall = true;

            const lengthValid = value.length >= 3 && value.length <= 150;
            updateValidationRuleUI(rules.length, lengthValid, field);
            if (!lengthValid && value.length > 0) isFieldValidOverall = false;

            const charsValid = /^[a-zA-Z0-9@.+_-]+$/.test(value) || value.length === 0;
            updateValidationRuleUI(rules.chars, charsValid, field);
            if (!charsValid && value.length > 0) isFieldValidOverall = false;
            
            if (value.length > 0) {
                field.classList.toggle('is-valid', isFieldValidOverall);
                field.classList.toggle('is-invalid', !isFieldValidOverall);
            } else {
                field.classList.remove('is-valid', 'is-invalid');
            }
        },
        { hideOnValidBlur: true }
    );

    setupFieldValidation(
        '{{ form.email.id_for_label }}', 
        'email-feedback', 
        { format: '#em-format' }, 
        function validateEmail(field, feedbackDiv, rules) {
            const value = field.value;
            const formatValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value) || value.length === 0;
            updateValidationRuleUI(rules.format, formatValid, field);

            if (value.length > 0) {
                field.classList.toggle('is-valid', formatValid);
                field.classList.toggle('is-invalid', !formatValid);
            } else {
                field.classList.remove('is-valid', 'is-invalid');
            }
        },
        { hideOnValidBlur: true } // Скрывать email фидбэк, если валидно
    );

    setupFieldValidation(
        '{{ form.password.id_for_label }}', 
        'password-rules-container', 
        { length: '#pr-length', letter: '#pr-letter', number: '#pr-number' }, 
        function validatePassword(field, feedbackDiv, rules) {
            const value = field.value;
            let isFieldValidOverall = true;

            const lengthValid = value.length >= 8;
            updateValidationRuleUI(rules.length, lengthValid, field);
            if (!lengthValid && value.length > 0) isFieldValidOverall = false;

            const letterValid = /[a-zA-Zа-яА-Я]/.test(value);
            updateValidationRuleUI(rules.letter, letterValid, field);
            if (!letterValid && value.length > 0) isFieldValidOverall = false;

            const numberValid = /\d/.test(value);
            updateValidationRuleUI(rules.number, numberValid, field);
            if (!numberValid && value.length > 0) isFieldValidOverall = false;

            if (value.length > 0) {
                field.classList.toggle('is-valid', isFieldValidOverall);
                field.classList.toggle('is-invalid', !isFieldValidOverall);
            } else {
                field.classList.remove('is-valid', 'is-invalid');
            }
        },
        { hideOnValidBlur: false } // Не скрывать password фидбэк, если валидно
    );
    
    const passwordFieldForP2 = document.getElementById('{{ form.password.id_for_label }}');
    const password2Field = document.getElementById('{{ form.password2.id_for_label }}');

    if (passwordFieldForP2 && password2Field) {
        setupFieldValidation(
            '{{ form.password2.id_for_label }}', 
            'password2-feedback', 
            { match: '#p2-match' },
            function validatePassword2Match(field, feedbackDiv, rules) {
                const value1 = passwordFieldForP2.value;
                const value2 = field.value;
                const matchValid = value1 === value2 || value2.length === 0;
                
                updateValidationRuleUI(rules.match, matchValid, field, value2.length > 0);

                if (value2.length > 0) {
                    field.classList.toggle('is-valid', matchValid);
                    field.classList.toggle('is-invalid', !matchValid);
                } else {
                    field.classList.remove('is-valid', 'is-invalid');
                }
            },
            { hideOnValidBlur: true } // Скрывать password2 фидбэк, если валидно и не пусто
        );

        // Перепроверка password2 при изменении password1
        passwordFieldForP2.addEventListener('input', () => {
            const p2Feedback = document.getElementById('password2-feedback');
            if (password2Field.value.length > 0 || document.activeElement === password2Field) {
                 if (p2Feedback && p2Feedback.classList.contains('visible')) {
                    const validateFunc = window.validatePassword2MatchGlob; // Используем глобальную ссылку
                    if(validateFunc) validateFunc(password2Field, p2Feedback, { match: p2Feedback.querySelector('#p2-match') });
                 }
            }
        });
        // Сохраняем ссылку на функцию валидации password2 глобально для вызова из другого слушателя
         window.validatePassword2MatchGlob = function(field, feedbackDiv, rules) {
            const value1 = passwordFieldForP2.value;
            const value2 = field.value;
            const matchValid = value1 === value2 || value2.length === 0;
            updateValidationRuleUI(rules.match, matchValid, field, value2.length > 0);
            if (value2.length > 0) {
                field.classList.toggle('is-valid', matchValid);
                field.classList.toggle('is-invalid', !matchValid);
            } else {
                field.classList.remove('is-valid', 'is-invalid');
            }
        };
    }
});
</script>
{% endblock %}